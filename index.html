
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiles Lapis - Adjacent Swap Puzzle</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseDependencies = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, onSnapshot };
    </script>
    <style>
        /* --- Base & Typography --- */
        :root {
            --body-bg: #0b0b1a;
            --primary-color: #ff5722;
            --secondary-color: #00bcd4;
            --tile-bg: #0f3460;
            --dark-shadow-primary: #c2401a;
            --dark-shadow-secondary: #007985;
            --dark-shadow-tile: #0a274b;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg); 
            color: #e4f9f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* --- Header & Stats --- */
        #header {
            width: 95%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 15px;
        }
        .stat {
            background-color: #1a1a2e;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-color);
        }

        /* --- Main Content Area --- */
        #content-wrapper {
            background-color: transparent;
            padding: 20px;
            border-radius: 20px;
            box-shadow: none;
            width: 95%;
            max-width: 420px;
            text-align: center;
            min-height: 480px;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .view {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }
        h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 900;
            text-shadow: 0 0 5px rgba(255, 87, 34, 0.5);
        }
        
        /* General Button Styling - Stylized Game UI Look */
        button {
            background-color: var(--primary-color);
            color: white;
            border: 2px solid #ffffff; 
            padding: 14px 25px;
            border-radius: 12px; 
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 
                0 6px var(--dark-shadow-primary),
                0 0 15px rgba(255, 87, 34, 0.6); 
            margin: 5px;
            font-weight: 700;
            text-transform: uppercase;
            overflow: hidden; /* Needed for clip-path */
        }
        button:active {
            box-shadow: 0 1px var(--dark-shadow-primary);
            transform: translateY(5px);
        }
        button.secondary-btn {
            background-color: var(--secondary-color);
            box-shadow: 
                0 6px var(--dark-shadow-secondary),
                0 0 15px rgba(0, 188, 212, 0.6);
        }
        button.secondary-btn:active {
            box-shadow: 0 1px var(--dark-shadow-secondary);
        }
        button.back-btn {
            background-color: var(--tile-bg);
            box-shadow: 0 6px var(--dark-shadow-tile);
            margin-top: 20px;
        }
        button.back-btn:active {
             box-shadow: 0 1px var(--dark-shadow-tile);
        }
        button:disabled {
            background-color: #444 !important;
            box-shadow: 0 3px #333 !important;
            cursor: not-allowed;
            color: #aaa;
        }
        
        .button-content {
            display: block;
            line-height: 1.2;
        }


        /* --- Main Menu Layout (Unique Angular Design) --- */
        #main-title {
            font-size: 2.5em;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-shadow: 0 0 15px var(--secondary-color);
        }

        #main-menu-view {
            justify-content: flex-start;
            padding-top: 30px;
        }

        #menu-content-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 20px;
            margin-top: 20px;
        }

        /* Large Central Play Button */
        #play-button-large {
            width: 80%;
            height: 120px;
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            box-shadow: 
                0 10px 0 #2e7d32, /* Darker Green base shadow */
                0 0 30px rgba(76, 175, 80, 0.7); /* Green outer glow */
            font-size: 1.4em;
            border-color: #e8f5e9;
            clip-path: polygon(5% 0%, 100% 0%, 95% 100%, 0% 100%); /* Angular shape */
            border-radius: 0; 
            transform: skewX(-5deg); /* Dynamic tilt */
        }
        #play-button-large:active {
            transform: translateY(5px) skewX(-5deg);
            box-shadow: 0 4px 0 #2e7d32;
        }
        #play-button-large .button-content {
            transform: skewX(5deg); /* Counter-tilt content */
        }

        /* Side Options Grouping */
        #menu-side-options {
            display: flex;
            flex-direction: column;
            width: 85%;
            gap: 12px;
        }

        .side-btn {
            clip-path: polygon(0% 0%, 90% 0%, 100% 100%, 10% 100%);
            border-radius: 0;
            padding: 10px 20px;
            font-size: 1em;
            transform: skewX(-10deg);
        }
        .side-btn:active {
            transform: translateY(4px) skewX(-10deg);
        }
        .side-btn .button-content {
            transform: skewX(10deg);
        }

        /* --- Puzzle Grid --- */
        #puzzle-grid {
            display: grid;
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            margin: 15px 0;
            border: 4px solid #4CAF50;
            border-radius: 10px;
            flex-shrink: 0;
        }
        .tile {
            position: absolute;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--body-bg);
            box-sizing: border-box;
            cursor: pointer;
            transition: transform 0.1s ease-out, top 0.1s ease-out, left 0.1s ease-out;
            touch-action: manipulation;
            z-index: 1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4), inset 0 0 8px rgba(255, 255, 255, 0.1); 
            border-radius: 5px;
        }
        
        .tile.selected {
            z-index: 10;
            border: 3px solid var(--secondary-color);
            box-shadow: 0 0 20px var(--secondary-color), inset 0 0 10px white;
            transform: scale(1.05);
        }

        .fallback-tile {
            background-color: var(--tile-bg) !important;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: 900;
        }

        /* --- Shop & Events Styling --- */
        .store-item {
            background-color: #1a1a2e;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            border: 1px solid var(--tile-bg);
        }
        
        #lang-buttons button {
            width: 100%;
            margin-bottom: 8px;
            transform: none; /* Override menu skew for settings buttons */
            clip-path: none;
            border-radius: 8px;
        }
        #lang-buttons button:active {
            transform: translateY(4px);
        }

        /* --- Modal Styling --- */
        #modal {
            background-color: rgba(0,0,0,0.9);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1a1a2e;
            padding: 25px;
            border-radius: 15px;
            max-width: 90%;
            width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.6);
            border: 1px solid var(--secondary-color);
        }
        #modal-actions button {
            margin: 10px 5px;
            transform: none;
            clip-path: none;
            border-radius: 8px;
        }
        #modal-actions button:active {
            transform: translateY(4px);
        }
    </style>
</head>
<body>

    <div id="header">
        <div class="stat">
            <span id="label-level">Level</span>: <span id="current-level-display">--</span>
        </div>
        <div class="stat">
            <span style="font-size: 1.2em;">üí∞</span> <span id="coin-display">--</span>
        </div>
    </div>

    <div id="content-wrapper">
        <!-- Main Menu View (Highly Stylized) -->
        <div id="main-menu-view" class="view" style="display: flex;">
            <h2 id="main-title">TILES LAPIS</h2>
            
            <div id="menu-content-container">
                <!-- Large Play Button -->
                <button id="play-button-large" onclick="viewManager.showView('puzzle')">
                    <span class="button-content">
                        <span style="font-size: 1.8em;">‚ñ∂Ô∏è</span><br>
                        <span id="menu-play-label">PLAY LEVEL</span> <span id="menu-level-display">--</span>
                    </span>
                </button>
                
                <!-- Secondary Options (Angular Side Stack) -->
                <div id="menu-side-options">
                    <button class="secondary-btn side-btn" onclick="viewManager.showView('shop')">
                        <span class="button-content"><span id="menu-shop-label">üõí SHOP</span></span>
                    </button>
                    <button class="secondary-btn side-btn" onclick="viewManager.showView('events')">
                        <span class="button-content"><span id="menu-events-label">üéÅ EVENTS</span></span>
                    </button>
                    <button class="secondary-btn side-btn" onclick="viewManager.showView('settings')">
                        <span class="button-content"><span id="menu-settings-label">‚öôÔ∏è SETTINGS</span></span>
                    </button>
                </div>
            </div>
            
            <div id="auth-status"></div>
        </div>

        <!-- Puzzle Game View -->
        <div id="puzzle-view" class="view">
            <h2 id="puzzle-status">Level -- | Swaps: 0</h2>
            <div id="puzzle-grid"></div>
            <div id="controls">
                <button onclick="puzzleGame.shuffleTiles()"><span id="btn-reshuffle" class="button-content">üîÑ Reshuffle</span></button>
                <button onclick="puzzleGame.useHint()"><span id="btn-hint" class="button-content">üí° Hint</span> (<span id="hints-display">0</span>)</button>
            </div>
            <button class="back-btn" onclick="viewManager.showView('menu')"><span id="btn-exit-menu">Exit to Menu</span></button>
        </div>

        <!-- Shop View -->
        <div id="shop-view" class="view">
            <h2 id="shop-title">üõí The Store</h2>
            <p id="shop-subtitle" style="color: #90a4ae;">Spend coins to get better gear!</p>
            <div id="shop-list">
                <div class="store-item">
                    <div class="item-details">
                        <h4 id="item-hint-title">Hint Pack (x3)</h4>
                        <p id="item-hint-desc">Reveals the correct position of one random tile.</p>
                    </div>
                    <button id="item-hint-btn" onclick="shopManager.buyItem('hints', 30)">
                        30 üí∞ Buy
                    </button>
                </div>
                <div class="store-item">
                    <div class="item-details">
                        <h4 id="item-bg-title">Background Change Token (BC)</h4>
                        <p id="item-bg-desc">Get a brand new puzzle image instantly for the next level!</p>
                    </div>
                    <button id="item-bg-btn" onclick="shopManager.buyItem('bg_token', 50)">
                        50 üí∞ Buy
                    </button>
                </div>
                <div class="store-item">
                    <div class="item-details">
                        <h4 id="item-skip-title">Level Skip Token (LST)</h4>
                        <p id="item-skip-desc">Skip the current level and advance to the next size.</p>
                    </div>
                    <button id="item-skip-btn" onclick="shopManager.buyItem('level_skip', 150)">
                        150 üí∞ Buy
                    </button>
                </div>
            </div>
            <button class="back-btn" onclick="viewManager.showView('menu')"><span id="btn-back-menu-shop">Back to Menu</span></button>
        </div>

        <!-- Events View -->
        <div id="events-view" class="view">
            <h2 id="events-title">üéÅ Events & Collabs</h2>
            <p id="events-subtitle" style="color: var(--secondary-color);">Daily rewards and special coins await!</p>
            <div id="event-list">
                <div class="store-item">
                    <div class="item-details">
                        <h4 id="event-welcome-title">Welcome Bonus</h4>
                        <p id="event-welcome-desc">Free 50 coins for joining the sliding community!</p>
                    </div>
                    <button id="claim-welcome" onclick="eventManager.claimWelcome(50)">
                        Claim 50 üí∞
                    </button>
                </div>
                <div class="store-item">
                    <div class="item-details">
                        <h4 id="event-offline-title">Offline Status</h4>
                        <p id="event-offline-desc">The current puzzle image is cached for offline play.</p>
                    </div>
                    <button disabled>
                        Ready
                    </button>
                </div>
            </div>
            <button class="back-btn" onclick="viewManager.showView('menu')"><span id="btn-back-menu-events">Back to Menu</span></button>
        </div>
        
        <!-- Settings View -->
        <div id="settings-view" class="view">
            <h2 id="settings-title">‚öôÔ∏è Settings</h2>
            <div id="language-selection">
                <h4 id="lang-select-title">Language Selection</h4>
                <div id="lang-buttons">
                    <!-- Language buttons populated by script -->
                </div>
            </div>
            <button class="back-btn" onclick="viewManager.showView('menu')"><span id="btn-back-menu-settings">Back to Menu</span></button>
        </div>

    </div>

    <!-- Universal Modal for Win/Error/Prompt -->
    <div id="modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <div id="modal-actions">
                <!-- Buttons will be inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        const ImageCacheKey = 'puzzleImagesBase64s';
        const MAX_CACHED_IMAGES = 3;
        const LANG_STORAGE_KEY = 'userLanguage';

        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, onSnapshot } = window.firebaseDependencies;

        let app, db, auth;
        let userId = 'loading';
        let userData = {
            coins: 0,
            maxLevel: 3, 
            currentLevel: 3,
            hintsAvailable: 0,
            bgTokens: 0, 
            levelSkipTokens: 0,
            claimedWelcome: false,
            language: localStorage.getItem(LANG_STORAGE_KEY) || 'en'
        };

        const localization = {
            currentLang: userData.language,
            languages: {
                'en': 'English',
                'ne': '‡§®‡•á‡§™‡§æ‡§≤‡•Ä (Nepali)',
                'es': 'Espa√±ol (Spanish)',
                'fil': 'Filipino'
            },
            strings: {
                'label-level': { 'en': 'Level', 'ne': '‡§∏‡•ç‡§§‡§∞', 'es': 'Nivel', 'fil': 'Antas' },
                'main-title': { 'en': 'TILES LAPIS', 'ne': '‡§ü‡§æ‡§á‡§≤ ‡§≤‡§æ‡§™‡§ø‡§∏', 'es': 'AZULEJOS LAPIS', 'fil': 'MGA TILE LAPIS' },
                'menu-play-label': { 'en': 'PLAY LEVEL', 'ne': '‡§∏‡•ç‡§§‡§∞ ‡§ñ‡•á‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç', 'es': 'JUGAR NIVEL', 'fil': 'MAGLARO SA ANTAS' },
                'menu-shop-label': { 'en': 'üõí SHOP', 'ne': 'üõí ‡§™‡§∏‡§≤', 'es': 'üõí TIENDA', 'fil': 'üõí BILIHAN' },
                'menu-events-label': { 'en': 'üéÅ EVENTS', 'ne': 'üéÅ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ', 'es': 'üéÅ EVENTOS', 'fil': 'üéÅ KAGANAPAN' },
                'menu-settings-label': { 'en': '‚öôÔ∏è SETTINGS', 'ne': '‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§ô‡§π‡§∞‡•Ç', 'es': '‚öôÔ∏è AJUSTES', 'fil': '‚öôÔ∏è MGA SETTING' },
                'btn-reshuffle': { 'en': 'üîÑ Reshuffle', 'ne': 'üîÑ ‡§´‡•á‡§∞‡§¨‡§¶‡§≤', 'es': 'üîÑ Rebarajar', 'fil': 'üîÑ Maglipat' },
                'btn-hint': { 'en': 'üí° Hint', 'ne': 'üí° ‡§∏‡§Ç‡§ï‡•á‡§§', 'es': 'üí° Pista', 'fil': 'üí° Palatandaan' },
                'btn-exit-menu': { 'en': 'Exit to Menu', 'ne': '‡§Æ‡•á‡§®‡•Å‡§Æ‡§æ ‡§´‡§∞‡•ç‡§ï‡§®‡•Å‡§π‡•ã‡§∏‡•ç', 'es': 'Salir al Men√∫', 'fil': 'Umalis sa Menu' },
                
                'shop-title': { 'en': 'üõí The Store', 'ne': 'üõí ‡§™‡§∏‡§≤', 'es': 'üõí La Tienda', 'fil': 'üõí Ang Tindahan' },
                'shop-subtitle': { 'en': 'Spend coins to get better gear!', 'ne': '‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§ó‡§ø‡§Ø‡§∞ ‡§™‡§æ‡§â‡§® ‡§∏‡§ø‡§ï‡•ç‡§ï‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç!', 'es': '¬°Gasta monedas para conseguir mejor equipo!', 'fil': 'Gumastos ng barya para sa mas mahusay na gamit!' },
                'item-hint-title': { 'en': 'Hint Pack (x3)', 'ne': '‡§∏‡§Ç‡§ï‡•á‡§§ ‡§™‡•ç‡§Ø‡§æ‡§ï (x3)', 'es': 'Paquete de Pistas (x3)', 'fil': 'Pangkat ng Palatandaan (x3)' },
                'item-hint-desc': { 'en': 'Reveals the correct position of one random tile.', 'ne': '‡§è‡§ï ‡§Ø‡§æ‡§¶‡•É‡§ö‡•ç‡§õ‡§ø‡§ï ‡§ü‡§æ‡§á‡§≤‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡•ç‡§∞‡§ï‡§ü ‡§ó‡§∞‡•ç‡§¶‡§õ‡•§', 'es': 'Revela la posici√≥n correcta de una ficha aleatoria.', 'fil': 'Ipinapakita ang tamang posisyon ng isang random na tile.' },
                'item-bg-title': { 'en': 'Background Change Token (BC)', 'ne': '‡§™‡•É‡§∑‡•ç‡§†‡§≠‡•Ç‡§Æ‡§ø ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ü‡•ã‡§ï‡§®', 'es': 'Ficha de Cambio de Fondo', 'fil': 'Token sa Pagbabago ng Background' },
                'item-bg-desc': { 'en': 'Get a brand new puzzle image instantly for the next level!', 'ne': '‡§Ö‡§∞‡•ç‡§ï‡•ã ‡§∏‡•ç‡§§‡§∞‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§§‡•Å‡§∞‡•Å‡§®‡•ç‡§§‡•à ‡§®‡§Ø‡§æ‡§Å ‡§™‡§ú‡§≤ ‡§õ‡§µ‡§ø ‡§™‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç!', 'es': '¬°Obt√©n una imagen de rompecabezas nueva al instante para el siguiente nivel!', 'fil': 'Kumuha ng bagong larawan ng puzzle agad para sa susunod na antas!' },
                'item-skip-title': { 'en': 'Level Skip Token (LST)', 'ne': '‡§∏‡•ç‡§§‡§∞ ‡§õ‡•ã‡§°‡•ç‡§®‡•á ‡§ü‡•ã‡§ï‡§®', 'es': 'Ficha para Omitir Nivel', 'fil': 'Token sa Pag-skip ng Antas' },
                'item-skip-desc': { 'en': 'Skip the current level and advance to the next size.', 'ne': '‡§π‡§æ‡§≤‡§ï‡•ã ‡§∏‡•ç‡§§‡§∞ ‡§õ‡•ã‡§°‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ ‡§Ö‡§∞‡•ç‡§ï‡•ã ‡§Ü‡§ï‡§æ‡§∞‡§Æ‡§æ ‡§Ö‡§ó‡§æ‡§°‡§ø ‡§¨‡§¢‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§', 'es': 'Omite el nivel actual y avanza al siguiente tama√±o.', 'fil': 'Laktawan ang kasalukuyang antas at umabante sa susunod na laki.' },
                
                'events-title': { 'en': 'üéÅ Events & Collabs', 'ne': 'üéÅ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞ ‡§∏‡§π‡§ï‡§æ‡§∞‡•ç‡§Ø', 'es': 'üéÅ Eventos y Colaboraciones', 'fil': 'üéÅ Mga Kaganapan at Collab' },
                'events-subtitle': { 'en': 'Daily rewards and special coins await!', 'ne': '‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡•Å‡§∞‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§∞ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡§ø‡§ï‡•ç‡§ï‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ‡§Æ‡§æ ‡§õ‡§®‡•ç!', 'es': '¬°Recompensas diarias y monedas especiales esperan!', 'fil': 'Naghihintay ang pang-araw-araw na gantimpala at espesyal na barya!' },
                'event-welcome-title': { 'en': 'Welcome Bonus', 'ne': '‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§¨‡•ã‡§®‡§∏', 'es': 'Bono de Bienvenida', 'fil': 'Bonus sa Pagtanggap' },
                'event-welcome-desc': { 'en': 'Free 50 coins for joining the sliding community!', 'ne': '‡§∏‡•ç‡§≤‡§æ‡§á‡§°‡§ø‡§ô ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø‡§Æ‡§æ ‡§∏‡§æ‡§Æ‡•á‡§≤ ‡§π‡•Å‡§®‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø 50 ‡§∏‡§ø‡§ï‡•ç‡§ï‡§æ ‡§®‡§ø‡§É‡§∂‡•Å‡§≤‡•ç‡§ï!', 'es': '¬°50 monedas gratis por unirte a la comunidad deslizante!', 'fil': 'Libreng 50 barya para sa pagsali sa sliding community!' },
                'event-offline-title': { 'en': 'Offline Status', 'ne': '‡§Ö‡§´‡§≤‡§æ‡§á‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø', 'es': 'Estado Desconectado', 'fil': 'Katayuan Offline' },
                'event-offline-desc': { 'en': 'The current puzzle image is cached for offline play.', 'ne': '‡§π‡§æ‡§≤‡§ï‡•ã ‡§™‡§ú‡§≤ ‡§õ‡§µ‡§ø ‡§Ö‡§´‡§≤‡§æ‡§á‡§® ‡§ñ‡•á‡§≤‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§ï‡•ç‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ‡•§', 'es': 'La imagen actual del rompecabezas est√° en cach√© para jugar sin conexi√≥n.', 'fil': 'Ang kasalukuyang larawan ng puzzle ay naka-cache para sa offline na laro.' },

                'settings-title': { 'en': '‚öôÔ∏è Settings', 'ne': '‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§ô‡§π‡§∞‡•Ç', 'es': '‚öôÔ∏è Ajustes', 'fil': '‚öôÔ∏è Mga Setting' },
                'lang-select-title': { 'en': 'Language Selection', 'ne': '‡§≠‡§æ‡§∑‡§æ ‡§ö‡§Ø‡§®', 'es': 'Selecci√≥n de Idioma', 'fil': 'Pagpili ng Wika' },
                
                'modal-hint-success': { 'en': 'Hint Used! üí°', 'ne': '‡§∏‡§Ç‡§ï‡•á‡§§ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡§ø‡§Ø‡•ã! üí°', 'es': '¬°Pista Usada! üí°', 'fil': 'Ginagamit ang Palatandaan! üí°' },
                'modal-win-title': { 'en': 'Level Cleared! üéâ', 'ne': '‡§∏‡•ç‡§§‡§∞ ‡§™‡•Ç‡§∞‡§æ ‡§≠‡§Ø‡•ã! üéâ', 'es': '¬°Nivel Completado! üéâ', 'fil': 'Tapos na ang Antas! üéâ' },
                'modal-win-message': { 'en': 'You earned 10 üí∞ and completed Level $SIZE$x$SIZE$ in $MOVES$ swaps! The next challenge is $NEXTSIZE$ x $NEXTSIZE$.', 'ne': '‡§§‡§™‡§æ‡§à‡§Ç‡§≤‡•á 10 üí∞ ‡§ï‡§Æ‡§æ‡§â‡§®‡•Å‡§≠‡§Ø‡•ã ‡§∞ $MOVES$ ‡§∏‡•ç‡§µ‡•à‡§™‡§Æ‡§æ ‡§∏‡•ç‡§§‡§∞ $SIZE$x$SIZE$ ‡§™‡•Ç‡§∞‡§æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§≠‡§Ø‡•ã! ‡§Ö‡§∞‡•ç‡§ï‡•ã ‡§ö‡•Å‡§®‡•å‡§§‡•Ä $NEXTSIZE$ x $NEXTSIZE$ ‡§π‡•ã‡•§', 'es': '¬°Ganaste 10 üí∞ y completaste el Nivel $SIZE$x$SIZE$ en $MOVES$ intercambios! El pr√≥ximo desaf√≠o es $NEXTSIZE$ x $NEXTSIZE$.', 'fil': 'Nakakuha ka ng 10 üí∞ at natapos ang Antas $SIZE$x$SIZE$ sa $MOVES$ na pagpapalit! Ang susunod na hamon ay $NEXTSIZE$ x $NEXTSIZE$.' },
                'puzzle-status-template': { 'en': 'Level $SIZE$x$SIZE$ | Swaps: $MOVES$', 'ne': '‡§∏‡•ç‡§§‡§∞ $SIZE$x$SIZE$ | ‡§∏‡•ç‡§µ‡•à‡§™: $MOVES$', 'es': 'Nivel $SIZE$x$SIZE$ | Intercambios: $MOVES$', 'fil': 'Antas $SIZE$x$SIZE$ | Palitan: $MOVES$' },
            },

            setLanguage(langCode) {
                if (this.languages[langCode]) {
                    this.currentLang = langCode;
                    localStorage.setItem(LANG_STORAGE_KEY, langCode);
                    userData.language = langCode;
                    this.updateText();
                }
            },

            getString(key, replacements = {}) {
                const text = this.strings[key] ? (this.strings[key][this.currentLang] || this.strings[key]['en']) : `MISSING_KEY_${key}`;
                let result = text;
                for (const [placeholder, value] of Object.entries(replacements)) {
                    result = result.replace(new RegExp(`\\$${placeholder}`, 'g'), value);
                }
                return result;
            },

            updateText() {
                const elements = document.querySelectorAll('[id^="label-"], [id^="menu-"], [id^="btn-"], [id^="shop-"], [id^="item-"], [id^="events-"], [id^="event-"], [id^="settings-"], [id^="lang-"]');
                elements.forEach(el => {
                    const key = el.id;
                    if (this.strings[key]) {
                        // For button content wrappers, we update the inner span
                        if (el.classList.contains('button-content')) {
                             el.innerHTML = this.getString(key);
                        } else {
                            el.textContent = this.getString(key);
                        }
                    }
                });
                
                // Special handling for dynamic button texts
                const buyText = { 'en': ' Buy', 'ne': ' ‡§ï‡§ø‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç', 'es': ' Comprar', 'fil': ' Bilhin' };
                document.getElementById('item-hint-btn').textContent = `30 üí∞${buyText[this.currentLang] || buyText['en']}`;
                document.getElementById('item-bg-btn').textContent = `50 üí∞${buyText[this.currentLang] || buyText['en']}`;
                document.getElementById('item-skip-btn').textContent = `150 üí∞${buyText[this.currentLang] || buyText['en']}`;

                // Update puzzle status template
                if (viewManager.currentView === 'puzzle') {
                    puzzleGame.updateStatus();
                }
                
                this.populateLanguageButtons();
                dataManager.updateUI();
            },

            populateLanguageButtons() {
                const container = document.getElementById('lang-buttons');
                container.innerHTML = '';
                for (const code in this.languages) {
                    const button = document.createElement('button');
                    button.textContent = this.languages[code];
                    if (code === this.currentLang) {
                        button.classList.add('secondary-btn');
                    } else {
                        button.style.backgroundColor = 'var(--tile-bg)';
                        button.style.boxShadow = '0 5px #0a274b';
                    }
                    button.onclick = () => {
                        this.setLanguage(code);
                        viewManager.showView('settings');
                    };
                    container.appendChild(button);
                }
            }
        };

        const imageManager = {
            cachedImage: null,

            async urlToBase64(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const blob = await response.blob();
                    return await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (e) {
                    return null;
                }
            },

            async getOrCreateImage(forceNew = false) {
                let cacheArray = JSON.parse(localStorage.getItem(ImageCacheKey) || '[]');
                
                if (!forceNew && cacheArray.length > 0) {
                    this.cachedImage = cacheArray[0];
                    return this.cachedImage;
                }

                const newImageBase64 = await this.urlToBase64('https://picsum.photos/400/400?random=' + Date.now());
                
                if (newImageBase64) {
                    cacheArray.unshift(newImageBase64);
                    cacheArray = cacheArray.slice(0, MAX_CACHED_IMAGES); 
                    localStorage.setItem(ImageCacheKey, JSON.stringify(cacheArray));
                    this.cachedImage = newImageBase64;
                    return newImageBase64;
                } else {
                    this.cachedImage = null;
                    return null;
                }
            },
            
            async changeBackground() {
                let cacheArray = JSON.parse(localStorage.getItem(ImageCacheKey) || '[]');
                
                if (cacheArray.length > 1) {
                    const nextImage = cacheArray.shift();
                    cacheArray.push(nextImage); 
                    localStorage.setItem(ImageCacheKey, JSON.stringify(cacheArray));
                    
                    this.cachedImage = cacheArray[0] || null;

                    // If we only had cached images, try fetching a fresh one in the background
                    if (cacheArray.length < MAX_CACHED_IMAGES) {
                        this.getOrCreateImage(true);
                    }

                } else {
                    // Force fetch new if only one or zero images exist
                    await this.getOrCreateImage(true);
                }
            }
        };

        const viewManager = {
            views: {
                'menu': document.getElementById('main-menu-view'),
                'puzzle': document.getElementById('puzzle-view'),
                'shop': document.getElementById('shop-view'),
                'events': document.getElementById('events-view'),
                'settings': document.getElementById('settings-view')
            },
            currentView: 'menu',
            async showView(viewName) {
                if (this.views[viewName]) {
                    this.views[this.currentView].style.display = 'none';
                    this.views[viewName].style.display = 'flex';
                    this.currentView = viewName;

                    if (viewName === 'puzzle') {
                        await imageManager.getOrCreateImage();
                        puzzleGame.startGame(userData.currentLevel);
                    }
                    dataManager.updateUI();
                    localization.updateText();
                }
            }
        };

        const dataManager = {
            dbRef: null,
            async initFirebase() {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    await new Promise(resolve => onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('auth-status').textContent = `User ID: ${userId}`;
                            this.dbRef = doc(db, 'artifacts', appId, 'users', userId, 'game_data', 'puzzleState');
                            resolve();
                        } else {
                            console.error("Authentication failed.");
                        }
                    }));
                    
                    this.startSnapshotListener();

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    document.getElementById('auth-status').textContent = `Auth Error: ${error.code}`;
                }
            },

            startSnapshotListener() {
                if (!this.dbRef) return;

                onSnapshot(this.dbRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const remoteData = docSnap.data();
                        userData = { ...userData, ...remoteData };
                        localization.setLanguage(userData.language || 'en');
                    } else {
                        await setDoc(this.dbRef, userData);
                    }
                    this.updateUI();
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    modal.show('Data Error', 'Could not load game data. Check your console for details.', [{ text: 'OK', action: 'modal.hide()' }]);
                });
            },

            async saveUserData() {
                if (!this.dbRef) return;
                try {
                    await setDoc(this.dbRef, userData);
                } catch (error) {
                    console.error("Error saving data:", error);
                }
            },

            updateUI() {
                document.getElementById('coin-display').textContent = userData.coins;
                document.getElementById('current-level-display').textContent = userData.currentLevel;
                document.getElementById('hints-display').textContent = userData.hintsAvailable;
                document.getElementById('menu-level-display').textContent = userData.currentLevel + 'x' + userData.currentLevel;

                const welcomeBtn = document.getElementById('claim-welcome');
                const claimText = ({ 'en': 'Claim 50 üí∞', 'ne': '‡§¶‡§æ‡§µ‡•Ä 50 üí∞', 'es': 'Reclamar 50 üí∞', 'fil': 'Kolektahin 50 üí∞' })[localization.currentLang] || 'Claim 50 üí∞';
                const claimedText = ({ 'en': 'Claimed!', 'ne': '‡§¶‡§æ‡§µ‡•Ä ‡§ó‡§∞‡§ø‡§Ø‡•ã!', 'es': '¬°Reclamado!', 'fil': 'Nakolekta!' })[localization.currentLang] || 'Claimed!';

                if (userData.claimedWelcome) {
                    welcomeBtn.textContent = claimedText;
                    welcomeBtn.disabled = true;
                    welcomeBtn.style.backgroundColor = '#4CAF50';
                    welcomeBtn.style.boxShadow = '0 3px #388E3C';
                } else {
                    welcomeBtn.textContent = claimText;
                    welcomeBtn.disabled = false;
                    welcomeBtn.style.backgroundColor = 'var(--primary-color)';
                    welcomeBtn.style.boxShadow = '0 3px var(--dark-shadow-primary)';
                }
            }
        };

        const shopManager = {
            async buyItem(item, cost) {
                if (userData.coins < cost) {
                    modal.show('Not Enough Coins!', `You need ${cost} üí∞ to buy this. You currently have ${userData.coins} üí∞.`, [{ text: 'Close', action: 'modal.hide()' }]);
                    return;
                }

                userData.coins -= cost;
                
                let message = '';
                if (item === 'hints') {
                    userData.hintsAvailable += 3;
                    message = '3 Hints have been added to your inventory.';
                } else if (item === 'bg_token') {
                    await imageManager.changeBackground();
                    message = 'The puzzle background has been refreshed for your next game!';
                } else if (item === 'level_skip') {
                    if (userData.currentLevel >= 6) {
                        userData.coins += cost;
                        message = 'You are already at max level (6x6). No need to skip!';
                    } else {
                        userData.currentLevel = Math.min(userData.currentLevel + 1, 6);
                        message = `You skipped to Level ${userData.currentLevel}x${userData.currentLevel}!`;
                    }
                }
                
                await dataManager.saveUserData();
                modal.show('Purchase Successful!', message, [{ text: 'Awesome!', action: 'modal.hide()' }]);
            }
        };

        const eventManager = {
            async claimWelcome(amount) {
                if (userData.claimedWelcome) return;

                userData.coins += amount;
                userData.claimedWelcome = true;

                await dataManager.saveUserData();
                modal.show(localization.getString('event-welcome-title'), 
                    `You received ${amount} üí∞! Your coins are now ${userData.coins}.`, 
                    [{ text: ({ 'en': 'Got It!', 'ne': '‡§¨‡•Å‡§ù‡•ç‡§Ø‡•ã!', 'es': '¬°Entendido!', 'fil': 'Nakuha!' })[localization.currentLang] || 'Got It!', action: 'modal.hide()' }] 
                );
            }
        };

        const puzzleGame = {
            tiles: [], size: 0, moves: 0, isSolving: false,
            GRID_DIV: document.getElementById('puzzle-grid'),
            selectedTile: null, 

            startGame(size) {
                this.size = size;
                this.moves = 0;
                this.isSolving = false;
                this.selectedTile = null;
                
                this.updateGridStyles(size);
                this.generateTiles(size, imageManager.cachedImage); 
                this.shuffleTiles();
                this.renderTiles();
                this.updateStatus();
            },

            updateGridStyles(size) {
                this.GRID_DIV.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
                this.GRID_DIV.style.gridTemplateRows = `repeat(${size}, 1fr)`;
            },

            generateTiles(size, imageBase64) {
                this.tiles = [];
                const totalTiles = size * size;
                const tileSizePercentage = 100 / size;
                this.GRID_DIV.innerHTML = '';
                
                for (let i = 0; i < totalTiles; i++) {
                    const row = Math.floor(i / size);
                    const col = i % size;

                    const tile = {
                        id: i, 
                        correctPos: i, 
                        currentPos: i, 
                        row: row, 
                        col: col, 
                        el: document.createElement('div')
                    };

                    tile.el.className = 'tile';
                    tile.el.style.width = `${tileSizePercentage}%`;
                    tile.el.style.height = `${tileSizePercentage}%`;
                    
                    if (imageBase64) {
                        tile.el.style.backgroundImage = `url('${imageBase64}')`;
                        const bgX = (col / (size - 1)) * 100;
                        const bgY = (row / (size - 1)) * 100;
                        tile.el.style.backgroundPosition = `${bgX}% ${bgY}%`;
                        tile.el.style.backgroundSize = `${size * 100}% ${size * 100}%`;
                    } else {
                        tile.el.classList.add('fallback-tile');
                        tile.el.textContent = (i + 1).toString();
                    }
                    
                    tile.el.addEventListener('click', () => this.handleTileClick(tile));

                    this.tiles.push(tile);
                    this.GRID_DIV.appendChild(tile.el);
                }
            },

            shuffleTiles() { 
                const totalTiles = this.tiles.length;
                const tempPositions = Array.from({length: totalTiles}, (_, i) => i);
                let solvable = false;
                
                while (!solvable) {
                    for (let i = totalTiles - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [tempPositions[i], tempPositions[j]] = [tempPositions[j], tempPositions[i]];
                    }
                    
                    for (let i = 0; i < totalTiles; i++) {
                        this.tiles[i].currentPos = tempPositions.findIndex(p => p === this.tiles[i].id); 
                    }
                    solvable = this.isSolvable(tempPositions); 
                }

                this.updateTilePositions();
                this.renderTiles();
                this.moves = 0; 
                this.updateStatus();
            },

            isSolvable(positions) { 
                let inversions = 0;
                
                for (let i = 0; i < positions.length; i++) {
                    for (let j = i + 1; j < positions.length; j++) {
                        if (positions[i] > positions[j]) { 
                             inversions++;
                        }
                    }
                }
                
                return inversions % 2 === 0;
            },
            
            updateTilePositions() { 
                const size = this.size;
                for (let i = 0; i < this.tiles.length; i++) {
                    const tile = this.tiles.find(t => t.currentPos === i); 
                    if (tile) {
                        tile.row = Math.floor(i / size);
                        tile.col = i % size;
                    }
                }
            },
            
            renderTiles() { 
                const size = this.size;
                const tileSizePercentage = 100 / size;
                const sortedTiles = this.tiles.sort((a, b) => a.currentPos - b.currentPos);

                sortedTiles.forEach(tile => {
                    const index = tile.currentPos;
                    const col = index % size;
                    const row = Math.floor(index / size);
                    tile.el.style.left = `${col * tileSizePercentage}%`;
                    tile.el.style.top = `${row * tileSizePercentage}%`;
                    tile.el.style.transform = `translate(0px, 0px)`;
                });
                this.updateTilePositions();
            },
            
            isAdjacent(tileA, tileB) {
                const dx = Math.abs(tileA.col - tileB.col);
                const dy = Math.abs(tileA.row - tileB.row);
                return (dx + dy === 1);
            },
            
            async swapTilePositions(tileA, tileB) {
                tileA.el.classList.remove('selected');
                
                [tileA.currentPos, tileB.currentPos] = [tileB.currentPos, tileA.currentPos];
                
                this.moves++;
                this.updateStatus();
                this.renderTiles();

                if (this.checkWin()) {
                    await this.handleWin();
                }
            },

            handleTileClick(clickedTile) {
                if (this.isSolving) return;

                if (this.selectedTile === clickedTile) {
                    this.selectedTile.el.classList.remove('selected');
                    this.selectedTile = null;
                } else if (this.selectedTile) {
                    if (this.isAdjacent(this.selectedTile, clickedTile)) {
                        this.swapTilePositions(this.selectedTile, clickedTile);
                        this.selectedTile = null;
                    } else {
                        this.selectedTile.el.classList.remove('selected');
                        this.selectedTile = clickedTile;
                        this.selectedTile.el.classList.add('selected');
                    }
                } else {
                    this.selectedTile = clickedTile;
                    this.selectedTile.el.classList.add('selected');
                }
            },

            checkWin() { 
                return this.tiles.every(tile => tile.id === tile.currentPos); 
            },

            async handleWin() {
                this.isSolving = true;
                userData.coins += 10;
                const oldLevel = userData.currentLevel;
                userData.currentLevel = Math.min(userData.currentLevel + 1, 6);
                userData.maxLevel = Math.max(userData.maxLevel, userData.currentLevel);
                imageManager.changeBackground(); 

                await dataManager.saveUserData();
                dataManager.updateUI();

                const message = localization.getString('modal-win-message', {
                    'SIZE': oldLevel,
                    'MOVES': this.moves,
                    'NEXTSIZE': userData.currentLevel
                });

                const nextLevelText = ({ 'en': `Next Level (${userData.currentLevel}x${userData.currentLevel})`, 'ne': `‡§Ö‡§∞‡•ç‡§ï‡•ã ‡§∏‡•ç‡§§‡§∞ (${userData.currentLevel}x${userData.currentLevel})`, 'es': `Siguiente Nivel (${userData.currentLevel}x${userData.currentLevel})`, 'fil': `Susunod na Antas (${userData.currentLevel}x${userData.currentLevel})` })[localization.currentLang] || `Next Level (${userData.currentLevel}x${userData.currentLevel})`;
                const exitMenuText = localization.getString('btn-exit-menu');

                const actions = [
                    { 
                        text: nextLevelText, 
                        action: `puzzleGame.startGame(${userData.currentLevel}); modal.hide();` 
                    },
                    { 
                        text: exitMenuText, 
                        action: `viewManager.showView('menu'); modal.hide();` 
                    }
                ];

                modal.show(localization.getString('modal-win-title'), message, actions);
            },

            updateStatus() {
                const statusTemplate = localization.getString('puzzle-status-template');
                const statusText = statusTemplate
                    .replace('$SIZE$', this.size).replace('$MOVES$', this.moves);

                document.getElementById('puzzle-status').textContent = statusText;
                document.getElementById('hints-display').textContent = userData.hintsAvailable;
            },

            async useHint() {
                if (userData.hintsAvailable < 1) {
                    modal.show('No Hints!', 'You need to buy hints from the Shop first.', [{ text: 'Go to Shop', action: "viewManager.showView('shop'); modal.hide();" }]);
                    return;
                }
                
                const unsolvedTiles = this.tiles.filter(t => t.id !== t.currentPos);
                if (unsolvedTiles.length === 0) {
                    modal.show('Puzzle Solved!', 'You already finished the puzzle!', [{ text: 'OK', action: 'modal.hide()' }]);
                    return;
                }

                userData.hintsAvailable--;
                await dataManager.saveUserData();
                dataManager.updateUI();

                const hintTile = unsolvedTiles[Math.floor(Math.random() * unsolvedTiles.length)];
                
                hintTile.el.style.border = '3px solid #FF0000';
                setTimeout(() => hintTile.el.style.border = '2px solid var(--body-bg)', 1500);

                const correctRow = Math.floor(hintTile.correctPos / this.size) + 1;
                const correctCol = (hintTile.correctPos % this.size) + 1;

                const hintMessage = ({
                    'en': `The highlighted tile (Tile #${hintTile.id + 1}) belongs in Row ${correctRow}, Column ${correctCol}.`,
                    'ne': `‡§π‡§æ‡§á‡§≤‡§æ‡§á‡§ü ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§ü‡§æ‡§á‡§≤ (‡§ü‡§æ‡§á‡§≤ #${hintTile.id + 1}) ‡§∞‡•ã ${correctRow}, ‡§∏‡•ç‡§§‡§Æ‡•ç‡§≠ ${correctCol} ‡§Æ‡§æ ‡§™‡§∞‡•ç‡§õ‡•§`,
                    'es': `La ficha resaltada (Ficha #${hintTile.id + 1}) pertenece a la Fila ${correctRow}, Columna ${correctCol}.`,
                    'fil': `Ang naka-highlight na tile (Tile #${hintTile.id + 1}) ay dapat nasa Hilera ${correctRow}, Kolum ${correctCol}.`
                })[localization.currentLang] || `The highlighted tile (Tile #${hintTile.id + 1}) belongs in Row ${correctRow}, Column ${correctCol}.`;

                modal.show(localization.getString('modal-hint-success'), 
                    hintMessage, 
                    [{ text: 'Got it!', action: 'modal.hide()' }]);
            },
        };

        const modal = {
            element: document.getElementById('modal'),
            title: document.getElementById('modal-title'),
            message: document.getElementById('modal-message'),
            actionsContainer: document.getElementById('modal-actions'),
            
            show(title, message, actions) {
                this.title.textContent = title;
                this.message.textContent = message;
                this.actionsContainer.innerHTML = '';
                
                if (Array.isArray(actions)) {
                    actions.forEach(action => {
                        const button = document.createElement('button');
                        button.textContent = action.text;
                        button.onclick = () => {
                            try {
                                eval(action.action);
                            } catch (e) {
                                console.error("Error executing modal action:", e);
                                modal.hide();
                            }
                        };
                        this.actionsContainer.appendChild(button);
                    });
                } else {
                    const button = document.createElement('button');
                    button.textContent = 'Close';
                    button.onclick = () => this.hide();
                    this.actionsContainer.appendChild(button);
                }
                
                this.element.style.display = 'flex';
            },

            hide() {
                this.element.style.display = 'none';
            }
        };


        window.onload = () => {
            window.viewManager = viewManager;
            window.puzzleGame = puzzleGame;
            window.shopManager = shopManager;
            window.eventManager = eventManager;
            window.modal = modal;
            window.imageManager = imageManager;
            window.localization = localization;

            localization.setLanguage(userData.language);
            localization.updateText();
            dataManager.initFirebase();

            imageManager.getOrCreateImage().then(() => {
                 viewManager.showView('menu');
            });
        };

    </script>
</body>
</html>
